generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id          String    @id @default(cuid())
  email       String    @unique
  password    String    // Hashed with bcrypt
  nickname    String
  role        String    @default("USER") // "USER", "ADMIN", or "BOT"
  profile_img        String?
  createdAt          DateTime  @default(now())
  lastNicknameUpdate DateTime? // For 30-day cooldown
  opinions           Opinion[]
  likes              OpinionLike[]
  suggestions        TopicSuggestion[]
  reports            Report[] @relation("ReportedBy")
  notifications      Notification[]

  @@map("users")
}

model TopicSuggestion {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("topic_suggestions")
}

model Topic {
  id          String    @id @default(cuid())
  title       String
  description String
  thumbnail   String?
  pros_label  String    @default("찬성")
  cons_label  String    @default("반대")
  pros_count  Int       @default(0)
  cons_count  Int       @default(0)
  createdAt   DateTime  @default(now())
  opinions    Opinion[]

  @@map("topics")
}

model Opinion {
  id          String   @id @default(cuid())
  topicId     String
  userId      String
  side        String   // "PROS" or "CONS"
  content     String
  likes_count Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now()) @updatedAt
  isEdited    Boolean   @default(false)
  isBlinded   Boolean   @default(false)
  parentId    String?
  parent      Opinion? @relation("OpinionReplies", fields: [parentId], references: [id])
  replies     Opinion[] @relation("OpinionReplies")
  
  topic       Topic    @relation(fields: [topicId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes       OpinionLike[]
  reports     Report[]

  @@map("opinions")
}

model OpinionLike {
  id        String   @id @default(cuid())
  opinionId String
  userId    String
  createdAt DateTime @default(now())

  opinion   Opinion  @relation(fields: [opinionId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, opinionId])
  @@map("opinion_likes")
}

model Report {
  id          String   @id @default(cuid())
  opinionId   String
  reporterId  String
  reason      String   // SPAM, ABUSE, HATE, OTHER
  description String?
  status      String   @default("PENDING") // PENDING, RESOLVED, DISMISSED
  createdAt   DateTime @default(now())
  resolvedAt  DateTime?

  opinion     Opinion  @relation(fields: [opinionId], references: [id], onDelete: Cascade)
  reporter    User     @relation("ReportedBy", fields: [reporterId], references: [id])

  @@unique([opinionId, reporterId])
  @@map("reports")
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // LIKE, REPLY, NEW_TOPIC
  message   String
  linkUrl   String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}
